name: Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build-release:
    name: Build Release
    runs-on: macos-15

    steps:
    - uses: actions/checkout@v4
    
    - name: Get Version from Tag
      id: version
      run: echo "VERSION=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
    
    - name: Select Latest Xcode
      run: |
        XCODE_PATH=$(ls -d /Applications/Xcode*.app 2>/dev/null | sort -V | tail -1)
        echo "Using Xcode at: $XCODE_PATH"
        sudo xcode-select -s "$XCODE_PATH"
        xcodebuild -version
    
    - name: Build iOS Release
      run: |
        xcodebuild archive \
          -project LocalHours.xcodeproj \
          -scheme LocalHours \
          -destination 'generic/platform=iOS' \
          -archivePath build/LocalHours-iOS.xcarchive \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          MARKETING_VERSION=${{ steps.version.outputs.VERSION }}
    
    - name: Build macOS Release
      run: |
        xcodebuild archive \
          -project LocalHours.xcodeproj \
          -scheme LocalHoursMac \
          -destination 'generic/platform=macOS' \
          -archivePath build/LocalHours-macOS.xcarchive \
          CODE_SIGN_IDENTITY="" \
          CODE_SIGNING_REQUIRED=NO \
          CODE_SIGNING_ALLOWED=NO \
          MARKETING_VERSION=${{ steps.version.outputs.VERSION }}
    
    - name: Package macOS App
      run: |
        mkdir -p build/release
        cp -R build/LocalHours-macOS.xcarchive/Products/Applications/LocalHoursMac.app build/release/
        cd build/release
        zip -r "LocalHours-macOS-${{ steps.version.outputs.VERSION }}.zip" LocalHoursMac.app
    
    - name: Package iOS App (Unsigned)
      run: |
        mkdir -p build/release/Payload
        cp -R build/LocalHours-iOS.xcarchive/Products/Applications/LocalHours.app build/release/Payload/
        cd build/release
        zip -r "LocalHours-iOS-${{ steps.version.outputs.VERSION }}-unsigned.ipa" Payload
        rm -rf Payload
    
    - name: Generate Release Notes
      id: notes
      run: |
        echo "NOTES<<EOF" >> $GITHUB_OUTPUT
        echo "## Local Hours v${{ steps.version.outputs.VERSION }}" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "### Downloads" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "| Platform | File | Notes |" >> $GITHUB_OUTPUT
        echo "|----------|------|-------|" >> $GITHUB_OUTPUT
        echo "| macOS | LocalHours-macOS-${{ steps.version.outputs.VERSION }}.zip | Unsigned app, may require allowing in Security settings |" >> $GITHUB_OUTPUT
        echo "| iOS | LocalHours-iOS-${{ steps.version.outputs.VERSION }}-unsigned.ipa | Unsigned IPA for sideloading (requires AltStore, Sideloadly, or similar) |" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "### Installation" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "**macOS:**" >> $GITHUB_OUTPUT
        echo "1. Download and unzip the macOS app" >> $GITHUB_OUTPUT
        echo "2. Move to Applications folder" >> $GITHUB_OUTPUT
        echo "3. Right-click and select 'Open' to bypass Gatekeeper on first launch" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "**iOS:**" >> $GITHUB_OUTPUT
        echo "1. Download the IPA file" >> $GITHUB_OUTPUT
        echo "2. Use AltStore, Sideloadly, or similar tool to install" >> $GITHUB_OUTPUT
        echo "3. Trust the developer in Settings > General > Device Management" >> $GITHUB_OUTPUT
        echo "" >> $GITHUB_OUTPUT
        echo "---" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
    
    - name: Upload Build Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: release-artifacts-${{ steps.version.outputs.VERSION }}
        path: |
          build/release/*.zip
          build/release/*.ipa
        retention-days: 90
    
    - name: Create GitHub Release
      uses: softprops/action-gh-release@v2
      with:
        files: |
          build/release/LocalHours-macOS-${{ steps.version.outputs.VERSION }}.zip
          build/release/LocalHours-iOS-${{ steps.version.outputs.VERSION }}-unsigned.ipa
        body: ${{ steps.notes.outputs.NOTES }}
        draft: true
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
